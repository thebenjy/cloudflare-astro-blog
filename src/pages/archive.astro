---
import Layout from '../layouts/Layout.astro';
import { readdir } from 'node:fs/promises';

const contentDir = './src/content/posts';
let posts = [];

try {
  const files = await readdir(contentDir);
  const postFiles = files.filter(f => f.endsWith('.json'));

  for (const file of postFiles) {
    const content = await import(`../content/posts/${file}`);
    posts.push(content.default);
  }

  posts.sort((a, b) => new Date(b.publishedAt) - new Date(a.publishedAt));
} catch (e) {
  console.log('No posts directory yet');
}

// Group by year
const postsByYear = posts.reduce((acc, post) => {
  const year = new Date(post.publishedAt).getFullYear();
  if (!acc[year]) acc[year] = [];
  acc[year].push(post);
  return acc;
}, {});
---

<Layout title="Archive - My Blog">
  <h1>Post Archive</h1>

  {Object.keys(postsByYear).sort((a, b) => b - a).map(year => (
    <div>
      <h2>{year}</h2>
      <ul class="archive-list">
        {postsByYear[year].map(post => (
          <li class="archive-item">
            <h3><a href={`/posts/${post.slug}`}>{post.title}</a></h3>
            <div class="post-meta">
              {new Date(post.publishedAt).toLocaleDateString('en-US', {
                month: 'long',
                day: 'numeric'
              })}
            </div>
          </li>
        ))}
      </ul>
    </div>
  ))}
</Layout>
