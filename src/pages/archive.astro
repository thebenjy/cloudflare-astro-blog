---
import Layout from '../layouts/Layout.astro';
import { readdir } from 'node:fs/promises';

const contentDir = './src/content/posts';
let posts = [];

try {
  const files = await readdir(contentDir);
  const postFiles = files.filter(f => f.endsWith('.md'));

  const postPromises = postFiles.map(async (file) => {
    const slug = file.replace('.md', '');
    const module = await import(`../content/posts/${file}`);
    return {
      slug,
      ...module.frontmatter,
      publishedAt: new Date(module.frontmatter.publishedAt)
    };
  });

  posts = await Promise.all(postPromises);
  posts.sort((a, b) => b.publishedAt - a.publishedAt);
} catch (error) {
  console.error('Error reading posts:', error);
}

// Group posts by year
const postsByYear = posts.reduce((acc, post) => {
  const year = post.publishedAt.getFullYear();
  if (!acc[year]) acc[year] = [];
  acc[year].push(post);
  return acc;
}, {});

const years = Object.keys(postsByYear).sort((a, b) => b - a);
---

<Layout title="Archive - My Blog" description="All blog posts organized by year">
  <div class="container">
    <h1 class="title is-2 mb-5">Archive</h1>

    {posts.length === 0 ? (
      <div class="notification is-info is-light">
        <p>No posts yet. Check back soon!</p>
      </div>
    ) : (
      <div class="content">
        <p class="subtitle is-5 mb-5">
          {posts.length} post{posts.length === 1 ? '' : 's'} total
        </p>

        {years.map((year) => (
          <div class="mb-6">
            <h2 class="title is-4">{year}</h2>
            <div class="box">
              {postsByYear[year].map((post) => (
                <div class="mb-4">
                  <div class="level is-mobile">
                    <div class="level-left">
                      <div class="level-item">
                        <span class="has-text-grey">
                          {post.publishedAt.toLocaleDateString('en-US', { 
                            month: 'short', 
                            day: 'numeric' 
                          })}
                        </span>
                      </div>
                      <div class="level-item">
                        <a href={`/posts/${post.slug}`} class="has-text-weight-semibold">
                          {post.title}
                        </a>
                      </div>
                    </div>
                  </div>
                  {post.tags && post.tags.length > 0 && (
                    <div class="tags ml-5 mt-2">
                      {post.tags.map((tag) => (
                        <span class="tag is-light">{tag}</span>
                      ))}
                    </div>
                  )}
                </div>
              ))}
            </div>
          </div>
        ))}
      </div>
    )}
  </div>
</Layout>
